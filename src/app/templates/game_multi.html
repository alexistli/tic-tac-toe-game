{% extends "layout.html" %} {% block title %} Tic Tac Toe - Play {% endblock %}
{% block head %} {{ super() }} {% endblock %} {% block content %}

<div class="flex flex-col h-screen justify-center items-center">
  <div class="text-7xl font font-extrabold tracking-tight text-gray-900">
    Tic Tac Toe Game
  </div>
  <p>
    Current transport is: <b><span id="transport"></span></b><br />
    Average ping/pong latency: <b><span id="ping-pong"></span>ms</b>
  </p>
  <p>
    room is: {{room}}<br />
    session is: {{session}}
  </p>
  <br />
  <form id="send_room" method="POST" action="#">
    <input
      type="text"
      name="room_name"
      id="room_name"
      placeholder="Room Name"
    />
    <input type="text" name="room_data" id="room_data" placeholder="Message" />
    <input type="submit" value="Send to Room" />
  </form>
  <h2>Receive:</h2>
  <div id="log"></div>
  <div class="mt-4 text-2xl font font-extrabold tracking-tight text-gray-900">
    Scores
  </div>
  <div id="scores">
    {% for score in scores %} Player {{ score[0] }} &mdash;
    <span>{{ score[1] }}</span>
    {% endfor %}
  </div>
  <div id="board" class="mt-8">{% include 'board_multi.html' %}</div>
  <a
    href="{{ url_for('main.new_game') }}"
    class="
      mt-10
      bg-blue-600
      rounded-md
      py-3
      px-8
      font-medium
      text-white
      hover:bg-blue-700
    "
    >Start over</a
  >
  {% endblock %} {% block scripts %}
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
    integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
    integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
    crossorigin="anonymous"
  ></script>
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function () {
      // Connect to the Socket.IO server.
      // The connection URL has the following format, relative to the current page:
      //     http[s]://<domain>:<port>[/<namespace>]
      var socket = io();

      // Event handler for new connections.
      // The callback function is invoked when a connection with the
      // server is established.
      socket.on("connect", function () {
        console.log("socket.on.connect");
        socket.emit("my_event", { data: "I'm connected!" });
        socket.emit("join", { room: "{{room}}" });
        socket.emit("my_room_event", { room: "{{room}}", data: "{{room}}" });
      });

      // Event handler for server sent data.
      // The callback function is invoked whenever the server emits data
      // to the client. The data is then displayed in the "Received"
      // section of the page.
      socket.on("my_response", function (msg, cb) {
        $("#log").append(
          "<br>" +
            $("<div/>")
              .text("Received #" + msg.count + ": " + msg.data)
              .html()
        );
        if (cb) cb();
      });

      // Interval function that tests message latency by sending a "ping"
      // message. The server then responds with a "pong" message and the
      // round trip time is measured.
      var ping_pong_times = [];
      var start_time;
      window.setInterval(function () {
        start_time = new Date().getTime();
        $("#transport").text(socket.io.engine.transport.name);
        socket.emit("my_ping");
      }, 1000);

      // Handler for the "pong" message. When the pong is received, the
      // time from the ping is stored, and the average of the last 30
      // samples is average and displayed.
      socket.on("my_pong", function () {
        var latency = new Date().getTime() - start_time;
        ping_pong_times.push(latency);
        ping_pong_times = ping_pong_times.slice(-30); // keep last 30 samples
        var sum = 0;
        for (var i = 0; i < ping_pong_times.length; i++)
          sum += ping_pong_times[i];
        $("#ping-pong").text(
          Math.round((10 * sum) / ping_pong_times.length) / 10
        );
      });

      $("form#send_room").submit(function (event) {
        socket.emit("my_room_event", {
          room: $("#room_name").val(),
          data: $("#room_data").val(),
        });
        return false;
      });

      socket.on("move", function (data) {
        console.log("socket.on.move");
        form_id = data.form_id;
        $("#room_name-" + form_id).val(data.room);
        $("#player_mark-" + form_id).val(data.player_mark);
        $("#coord-" + form_id).val(data.coord);
        $("#button-" + form_id).attr("hx-post", "/move_multi");
        $("#button-" + form_id).attr("hx-target", "#board");
        $("form#move-" + form_id).submit();
      });

      $("#board").on("submit", $("form[id|='move']"), function (event) {
        event.preventDefault();
        console.log("form.move.submit");
        var form_id = this.id.split("-")[1];
        var cell = form_id.split("").join(" ");
        console.log(cell);
        socket.emit("move", {
          room: "{{room}}",
          player_mark: "{{turn}}",
          form_id: form_id,
          coord: cell,
        });
        var my_form = "#form-" + form_id;
        console.log(my_form);
        htmx.trigger(htmx.find(my_form), "submit", {});
      });
    });
  </script>

  {% endblock %}
</div>
